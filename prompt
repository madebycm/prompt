#!/bin/bash
# combine_sources.sh
# This script combines every committed source code (text) file in a Git repository
# into a single file named prompt.txt.
# It supports optional filters:
#   --include=DIR/         Only include files in DIR/ (and its subfolders)
#   --exclude=file1,file2   Exclude any file with a basename matching file1, file2, etc.
# The output tags now show the absolute path of each file based on the directory from where the script is run.

# Default values for optional parameters.
INCLUDE=""
EXCLUDE=""

# Parse command line arguments.
for arg in "$@"; do
    case $arg in
        --include=*)
            INCLUDE="${arg#*=}"
            ;;
        --exclude=*)
            EXCLUDE="${arg#*=}"
            ;;
    esac
done

# If INCLUDE is set, ensure it ends with a slash.
if [ -n "$INCLUDE" ]; then
    case "$INCLUDE" in
        */) ;;  # already has a trailing slash.
        *) INCLUDE="${INCLUDE}/" ;;
    esac
fi

# Verify that we are in a Git repository.
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Error: This directory is not a Git repository."
    exit 1
fi

# Get the absolute path of the current directory.
BASE_DIR="$(pwd)"

OUTPUT_FILE="prompt.txt"

# Clear or create the output file.
> "$OUTPUT_FILE"

# If EXCLUDE is provided, split it into an array.
IFS=',' read -r -a excludeArray <<< "$EXCLUDE"

# Process each file tracked in the current HEAD.
git ls-tree -r HEAD --name-only | while IFS= read -r file; do
    # Skip the output file if it's tracked by Git.
    if [ "$file" = "$OUTPUT_FILE" ]; then
        continue
    fi

    # If INCLUDE is set, only process files that start with the provided directory.
    if [ -n "$INCLUDE" ]; then
        case "$file" in
            "$INCLUDE"*) ;;  # match, continue processing.
            *) continue ;;   # no match, skip.
        esac
    fi

    # If EXCLUDE is set, check if the file's basename matches any exclude entry.
    if [ ${#excludeArray[@]} -gt 0 ]; then
        basename_file=$(basename "$file")
        for exclude in "${excludeArray[@]}"; do
            if [ "$basename_file" = "$exclude" ]; then
                continue 2  # Skip to the next file.
            fi
        done
    fi

    # Only process regular files that exist.
    if [ -f "$file" ]; then
        # Check if the file is a text file.
        if file "$file" | grep -q 'text'; then
            ABS_PATH="${BASE_DIR}/${file}"
            echo "<${ABS_PATH}>" >> "$OUTPUT_FILE"
            cat "$file" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            echo "</${ABS_PATH}>" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
        fi
    fi
done

echo "Combined source files have been written to $OUTPUT_FILE"
